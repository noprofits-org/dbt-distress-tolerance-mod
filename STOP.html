<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>STOP Skill Guide</title>
    <!-- Add Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Include shared styles - properly formatted for templating -->
    <style>
    <?!= include('dbt-skills-styles'); ?>
    </style>
</head>

<body>
    <!-- Add this near the top of the body -->
    <div class="float-end">
        <small class="text-muted">Time spent: <span id="timer-display">00:00</span></small>
    </div>
    <div class="container">
        <div class="row mb-4">
            <div class="col-md-8 offset-md-2">
                <h1 class="text-center mb-4">The STOP Skill</h1>

                <div class="header-section">
                    <h3 class="mb-3">Overview</h3>
                    <p>The STOP skill is one of the key crisis survival strategies in DBT (Dialectical Behavior
                        Therapy). It's designed to help you pause in moments of high emotion or crisis before reacting
                        in ways that might make things worse.</p>
                    <p>STOP is an acronym that stands for:</p>
                    <ul>
                        <li><strong>S</strong>top</li>
                        <li><strong>T</strong>ake a step back</li>
                        <li><strong>O</strong>bserve</li>
                        <li><strong>P</strong>roceed mindfully</li>
                    </ul>
                    <p>This skill is especially useful when you're feeling overwhelmed or when your emotions are
                        threatening to drive impulsive behaviors.</p>
                </div>

                <!-- Rest of STOP.html content remains the same -->
                <!-- ... -->

                <div class="text-center mt-4 mb-4" id="dashboard-link">
                    <a href="#" class="btn btn-secondary" onclick="google.script.run.openDashboard()">Back to
                        Dashboard</a>
                </div>
            </div>
        </div>
    </div>
    <div id="confirmation-message" class="alert alert-success text-center mt-5" style="display: none;">
        <h4>Practice Logged Successfully!</h4>
        <p>Your STOP skill practice has been recorded.</p>
        <p>You spent <span id="time-spent"></span> learning this skill.</p>
        <button class="btn btn-primary mt-3" onclick="google.script.run.openDashboard()">
            Return to Dashboard
        </button>
    </div>
    <div id="return-after-quiz" style="display: none;" class="mt-3">
        <button class="btn btn-secondary" onclick="google.script.run.openDashboard()">
            Return to Dashboard
        </button>
    </div>

    <!-- Add Bootstrap JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Include shared scripts - properly formatted for templating -->
    <script>
    <?!= include('dbt-skills-scripts'); ?>
    </script>
    
    <!-- Skill-specific JavaScript -->
    <script>
        // Initialize skill-specific variables
        let totalQuestions = 3;
        let skillInfo = {
            name: 'STOP',
            type: 'Crisis Survival',
            totalQuestions: totalQuestions
        };
        
        // Start timer when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Start timer
            startTimer();
            
            // Track skill guide view
            google.script.run.trackSkillGuideView('STOP');
        });
        
        // When user completes the quiz
        function logSessionWithQuiz() {
            // Stop the timer if it's still running
            clearInterval(timerInterval);
            
            // Disable the button
            const logButton = document.querySelector('.btn-log-session');
            logButton.disabled = true;
            logButton.textContent = "Logging...";
            
            // Get user notes if provided
            const userNotes = document.getElementById('user-notes').value;
            
            // Create notes text combining quiz results and user notes
            let notesText = `${skillInfo.name} Skill Quiz: Score ${quizScore}/${skillInfo.totalQuestions}. `;
            if (userNotes) {
                notesText += `User notes: ${userNotes}`;
            }
            
            // Prepare log data
            const logData = {
                skillType: skillInfo.type,
                skillName: skillInfo.name,
                distressBefore: 0,
                distressAfter: 0,
                effectiveness: Math.min(5, Math.ceil((quizScore / skillInfo.totalQuestions) * 5)),
                timeSpent: timeSpent / 60, // Convert seconds to minutes
                quizScore: quizScore + "/" + skillInfo.totalQuestions,
                notes: notesText
            };
            
            // Call the server-side function to log the practice
            google.script.run
                .withSuccessHandler(function(result) {
                    // Update the button
                    logButton.textContent = "Logged Successfully!";
                    
                    // Show a return to dashboard button
                    document.getElementById('return-after-quiz').style.display = 'block';
                    
                    // Update confirmation message
                    document.getElementById('confirmation-message').style.display = 'block';
                    document.getElementById('time-spent').textContent = 
                        `${Math.floor(timeSpent / 60)} minutes and ${timeSpent % 60} seconds`;
                })
                .withFailureHandler(function(error) {
                    // Show error and re-enable button
                    alert('Error logging session: ' + error);
                    logButton.disabled = false;
                    logButton.textContent = "Complete Practice Session";
                })
                .logSkillWithTime(logData);
        }
    </script>
</body>

</html>