<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>STOP Skill Guide</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .header-section {
            background-color: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        .skill-letter {
            font-size: 36px;
            font-weight: bold;
            color: #1890ff;
            margin-right: 10px;
            display: inline-block;
            width: 50px;
            height: 50px;
            text-align: center;
            line-height: 50px;
            border-radius: 50%;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .practice-card {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .example-section {
            background-color: #fff8e6;
            border-left: 4px solid #faad14;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .quote {
            font-style: italic;
            border-left: 4px solid #ddd;
            padding-left: 15px;
            margin: 20px 0;
        }

        .interactive-section {
            background-color: #f6ffed;
            border-left: 4px solid #52c41a;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .scenario-card {
            background-color: white;
            border: 1px solid #e8e8e8;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scenario-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .response-card {
            background-color: #f0f8ff;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .response-card.correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .response-card.incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
</head>

<body>
    <div class="float-end">
        <small class="text-muted">Time spent: <span id="timer-display">00:00</span></small>
    </div>
    <div class="container">
        <div class="row mb-4">
            <div class="col-md-8 offset-md-2">
                <h1 class="text-center mb-4">The STOP Skill</h1>
                <div class="header-section">
                    <h3 class="mb-3">Overview</h3>
                    <p>The STOP skill is one of the key crisis survival strategies in DBT (Dialectical Behavior
                        Therapy). It's designed to help you pause in moments of high emotion or crisis before reacting
                        in ways that might make things worse.</p>
                    <p>STOP is an acronym that stands for:</p>
                    <ul>
                        <li><strong>S</strong>top</li>
                        <li><strong>T</strong>ake a step back</li>
                        <li><strong>O</strong>bserve</li>
                        <li><strong>P</strong>roceed mindfully</li>
                    </ul>
                    <p>This skill is especially useful when you're feeling overwhelmed or when your emotions are
                        threatening to drive impulsive behaviors.</p>
                </div>
                <div class="practice-card">
                    <h3 class="mb-3">How to Practice STOP</h3>
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <span class="skill-letter">S</span>
                            <h4 class="mb-0">STOP</h4>
                        </div>
                        <p>Literally stop what you're doing. Freeze. Don't move a muscle! Don't act immediately on your
                            urges, feelings, or impulses. Put the brakes on whatever you're about to say or do.</p>
                        <div class="quote">"Emotions try to boss me around and tell me what to do. When I notice this
                            happening, I need to remember that I can Stop."</div>
                    </div>
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <span class="skill-letter">T</span>
                            <h4 class="mb-0">Take a step back</h4>
                        </div>
                        <p>Take a step back from the situation. This could be physical (actually stepping away) or
                            mental (detaching from your emotional response). Take a break. Take a deep breath. Count to
                            10.</p>
                        <div class="quote">"When I'm about to react to my emotions, I need to Take a step back, creating
                            space between my feelings and my actions."</div>
                    </div>
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <span class="skill-letter">O</span>
                            <h4 class="mb-0">Observe</h4>
                        </div>
                        <p>Notice what's going on inside and outside of you. What is the situation? What are your
                            thoughts and feelings? What are others saying or doing? Try to observe without judgment.</p>
                        <div class="quote">"I need to Observe what's actually happening rather than getting lost in my
                            emotional interpretation of events."</div>
                    </div>
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <span class="skill-letter">P</span>
                            <h4 class="mb-0">Proceed mindfully</h4>
                        </div>
                        <p>Act with awareness, considering your goals and the facts of the situation. Ask yourself: What
                            actions will make the situation better or worse? What is the most effective response here?
                        </p>
                        <div class="quote">"After I've created space and observed, I can Proceed mindfully, making a
                            choice that serves my goals rather than my momentary emotions."</div>
                    </div>
                </div>
                <div class="example-section">
                    <h3 class="mb-3">A Humorous Example: The Team Meeting Meltdown</h3>
                    <p><strong>The Situation:</strong> Dave is in a team meeting when his coworker Sarah takes credit
                        for an idea he shared last week. Dave feels his blood pressure rising and his face getting hot.
                        He's about to blurt out "That was MY idea, actually!" in front of the whole team.</p>
                    <div class="mb-3"><strong>S - Stop:</strong> Dave catches himself just before speaking. He feels his
                        mouth open but clamps it shut. His brain is yelling "STOP RIGHT THERE!" like a traffic cop.
                    </div>
                    <div class="mb-3"><strong>T - Take a step back:</strong> Dave takes a deep breath and mentally steps
                        back from his anger. He imagines his rage as a cartoon character jumping up and down beside him
                        rather than controlling him. He thinks, "Well, hello there, Mr. Fury. I see you're visiting
                        again."</div>
                    <div class="mb-3"><strong>O - Observe:</strong> Dave notices his physical sensations: racing heart,
                        sweaty palms, tight jaw. He observes his thoughts: "She's stealing my thunder! Everyone will
                        think I never have good ideas!" He notices that the meeting is actually going well, and the boss
                        seems pleased with the progress.</div>
                    <div class="mb-3"><strong>P - Proceed mindfully:</strong> Dave considers his options. He could: 1)
                        Call Sarah out and create tension, 2) Silently stew in resentment, or 3) Find a constructive way
                        to acknowledge his contribution. He decides to wait for a natural pause and then say, "I'm glad
                        we're developing that idea I brought up last week. I think Sarah's added some great points to
                        it."</div>
                    <p><strong>The Result:</strong> Instead of creating workplace drama, Dave manages his emotions,
                        maintains professional relationships, AND still gets appropriate credit for his contribution.
                        Later, he treats himself to an extra-large coffee for handling a difficult situation with skill.
                    </p>
                </div>
                <div class="interactive-section">
                    <h3 class="mb-3">Practice Scenarios Quiz</h3>
                    <p>Test your understanding of how to apply the STOP skill in different situations:</p>
                    <div class="score-tracker mb-3">Current score: <span id="quiz-score">0 / 0</span></div>
                    <!-- Question 1 -->
                    <div class="card mb-4">
                        <div class="card-header">Scenario 1: The Text Message</div>
                        <div class="card-body">
                            <p>You see your partner texting someone and briefly glimpse a heart emoji. You immediately
                                feel jealous and are about to grab their phone. What's the best application of the STOP
                                skill?</p>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="scenario-1" id="scenario-1-option-1"
                                    value="1" onclick="checkAnswer(1, 1, 3)">
                                <label class="form-check-label" for="scenario-1-option-1">Ask them directly who they're
                                    texting and why they're using heart emojis</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="scenario-1" id="scenario-1-option-2"
                                    value="2" onclick="checkAnswer(1, 2, 3)">
                                <label class="form-check-label" for="scenario-1-option-2">Grab the phone quickly so they
                                    don't have time to hide anything</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="scenario-1" id="scenario-1-option-3"
                                    value="3" onclick="checkAnswer(1, 3, 3)">
                                <label class="form-check-label" for="scenario-1-option-3">Pause, take a deep breath, and
                                    observe your jealousy before deciding what to do</label>
                            </div>
                            <div id="feedback-1" class="mt-3"></div>
                            <div id="response-1" class="response-card mt-3" style="display: none;">
                                <h6>STOP Skill Application:</h6>
                                <p><strong>S - Stop:</strong> Freeze before reaching for the phone.</p>
                                <p><strong>T - Take a step back:</strong> Take a deep breath and remind yourself that
                                    context matters.</p>
                                <p><strong>O - Observe:</strong> Notice your jealousy, but also observe that your
                                    partner has many friends and family they care about.</p>
                                <p><strong>P - Proceed mindfully:</strong> Choose to either wait until you're calmer to
                                    have a conversation or ask non-accusingly, "Who are you texting with such
                                    enthusiasm?"</p>
                            </div>
                        </div>
                    </div>
                    <!-- Question 2 -->
                    <div class="card mb-4">
                        <div class="card-header">Scenario 2: The Email Reply</div>
                        <div class="card-body">
                            <p>You receive a critical email from your boss that feels unfair. You immediately start
                                typing an angry response. What's the best first step using the STOP skill?</p>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="scenario-2" id="scenario-2-option-1"
                                    value="1" onclick="checkAnswer(2, 1, 1)">
                                <label class="form-check-label" for="scenario-2-option-1">Stop typing and remove your
                                    hands from the keyboard</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="scenario-2" id="scenario-2-option-2"
                                    value="2" onclick="checkAnswer(2, 2, 1)">
                                <label class="form-check-label" for="scenario-2-option-2">Finish writing your email but
                                    save it as a draft to review later</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="scenario-2" id="scenario-2-option-3"
                                    value="3" onclick="checkAnswer(2, 3, 1)">
                                <label class="form-check-label" for="scenario-2-option-3">Forward the email to a
                                    coworker to get their perspective</label>
                            </div>
                            <div id="feedback-2" class="mt-3"></div>
                            <div id="response-2" class="response-card mt-3" style="display: none;">
                                <h6>STOP Skill Application:</h6>
                                <p><strong>S - Stop:</strong> Remove your hands from the keyboard immediately.</p>
                                <p><strong>T - Take a step back:</strong> Get up and take a brief walk, or at least look
                                    away from the screen.</p>
                                <p><strong>O - Observe:</strong> Notice your defensive feelings and the urge to justify
                                    yourself. Also observe the actual content of the criticism.</p>
                                <p><strong>P - Proceed mindfully:</strong> Wait at least an hour before responding. Then
                                    draft a professional response that addresses the substantive points without
                                    emotional reactivity.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Question 3 -->
                    <div class="card mb-4">
                        <div class="card-header">Scenario 3: The Empty Refrigerator</div>
                        <div class="card-body">
                            <p>You open the fridge to find your roommate ate the leftovers you were saving for dinner.
                                You're starving and about to go confront them aggressively. Which sequence correctly
                                applies the STOP skill?</p>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="scenario-3" id="scenario-3-option-1"
                                    value="1" onclick="checkAnswer(3, 1, 2)">
                                <label class="form-check-label" for="scenario-3-option-1">Observe your hunger, Stop your
                                    reaction, Take a step back, Proceed to talk calmly</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="scenario-3" id="scenario-3-option-2"
                                    value="2" onclick="checkAnswer(3, 2, 2)">
                                <label class="form-check-label" for="scenario-3-option-2">Stop, Take a step back,
                                    Observe your feelings, Proceed mindfully</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="scenario-3" id="scenario-3-option-3"
                                    value="3" onclick="checkAnswer(3, 3, 2)">
                                <label class="form-check-label" for="scenario-3-option-3">Proceed to eat something else,
                                    Stop your anger, Take note of your feelings, Observe the situation</label>
                            </div>
                            <div id="feedback-3" class="mt-3"></div>
                            <div id="response-3" class="response-card mt-3" style="display: none;">
                                <h6>STOP Skill Application:</h6>
                                <p><strong>S - Stop:</strong> Pause before storming off to your roommate's room.</p>
                                <p><strong>T - Take a step back:</strong> Close the fridge and take a few deep breaths.
                                </p>
                                <p><strong>O - Observe:</strong> Notice your hunger and frustration. Also observe that
                                    there might have been a miscommunication about the leftovers.</p>
                                <p><strong>P - Proceed mindfully:</strong> Find something else to eat first, then when
                                    you're not "hangry," have a calm conversation about labeling food in the future.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Final Score Section -->
                    <div id="final-score-section" class="alert alert-info text-center" style="display: none;">
                        <h4>Quiz Complete!</h4>
                        <p>Your final score: <span id="final-score"></span></p>
                        <p>Now that you've tested your understanding, try applying the STOP skill in real-life
                            situations.</p>
                        <div class="mb-3 mt-3">
                            <label for="user-notes" class="form-label">Notes or Questions for Your Therapist
                                (Optional)</label>
                            <textarea class="form-control" id="user-notes" rows="3"
                                placeholder="Enter any notes or questions about this skill..."></textarea>
                        </div>
                        <button class="btn btn-primary mt-2 btn-log-session" onclick="logSessionWithQuiz()">Complete
                            Practice Session</button>
                    </div>
                    <h3>When to Use the STOP Skill</h3>
                    <ul>
                        <li>When you're in a highly emotional state (anger, fear, jealousy, etc.)</li>
                        <li>When you feel an urge to engage in impulsive or harmful behavior</li>
                        <li>Before responding to provocative or upsetting communications</li>
                        <li>When you're in conflict with someone and about to say something you might regret</li>
                        <li>When you notice your emotions are driving your behavior</li>
                    </ul>
                </div>
                <div class="text-center mt-4 mb-4" id="dashboard-link">
                    <a href="#" class="btn btn-secondary" onclick="google.script.run.openDashboard()">Back to
                        Dashboard</a>
                </div>
            </div>
        </div>
    </div>
    <div id="confirmation-message" class="alert alert-success text-center mt-5" style="display: none;">
        <h4>Practice Logged Successfully!</h4>
        <p>Your STOP skill practice has been recorded.</p>
        <p>You spent <span id="time-spent"></span> learning this skill.</p>
        <button class="btn btn-primary mt-3" onclick="google.script.run.openDashboard()">Return to Dashboard</button>
    </div>
    <div id="return-after-quiz" style="display: none;" class="mt-3">
        <button class="btn btn-secondary" onclick="google.script.run.openDashboard()">Return to Dashboard</button>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Common variables
        let startTime;
        let timeSpent = 0;
        let timerInterval;
        let quizScore = 0;
        let questionsAnswered = 0;
        let quizCompleted = false;

        // Skill-specific variables
        let totalQuestions = 3;
        let skillInfo = {
            name: 'STOP',
            type: 'Crisis Survival',
            totalQuestions: totalQuestions
        };

        // Start timer when page loads
        document.addEventListener('DOMContentLoaded', function () {
            startTimer();
            google.script.run.trackSkillGuideView('STOP');
        });

        function startTimer() {
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const currentTime = new Date();
            timeSpent = Math.floor((currentTime - startTime) / 1000); // time in seconds
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            document.getElementById('timer-display').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function checkAnswer(scenarioId, selectedOption, correctOption) {
            const responseDiv = document.getElementById(`response-${scenarioId}`);
            const feedbackDiv = document.getElementById(`feedback-${scenarioId}`);
            questionsAnswered++;
            if (selectedOption === correctOption) {
                quizScore++;
                feedbackDiv.innerHTML = '<div class="alert alert-success">Correct! Great application of the skill.</div>';
            } else {
                feedbackDiv.innerHTML = '<div class="alert alert-danger">Not quite. Review the correct application above.</div>';
            }
            responseDiv.style.display = 'block';
            updateQuizScore();
            const options = document.querySelectorAll(`input[name="scenario-${scenarioId}"]`);
            options.forEach(option => option.disabled = true);
        }

        function updateQuizScore() {
            const scoreDisplay = document.getElementById('quiz-score');
            scoreDisplay.textContent = `${quizScore} / ${questionsAnswered}`;
            if (questionsAnswered === totalQuestions) {
                document.getElementById('final-score-section').style.display = 'block';
                document.getElementById('final-score').textContent = `${quizScore} / ${totalQuestions}`;
                quizCompleted = true;
            }
        }

        function logSessionWithQuiz() {
            clearInterval(timerInterval);
            const logButton = document.querySelector('.btn-log-session');
            logButton.disabled = true;
            logButton.textContent = "Logging...";

            const userNotes = document.getElementById('user-notes').value;
            let notesText = `${skillInfo.name} Skill Quiz: Score ${quizScore}/${skillInfo.totalQuestions}. `;
            if (userNotes) notesText += `User notes: ${userNotes}`;

            const logData = {
                skillType: skillInfo.type,
                skillName: skillInfo.name,
                distressBefore: 0,
                distressAfter: 0,
                effectiveness: Math.min(5, Math.ceil((quizScore / skillInfo.totalQuestions) * 5)),
                timeSpent: timeSpent / 60, // Convert to minutes
                quizScore: `${quizScore}/${skillInfo.totalQuestions}`,
                notes: notesText
            };

            google.script.run
                .withSuccessHandler(function (result) {
                    try {
                        logButton.textContent = "Logged Successfully!";
                        document.getElementById('return-after-quiz').style.display = 'block';
                        document.getElementById('confirmation-message').style.display = 'block';
                        document.getElementById('time-spent').textContent = `${Math.floor(timeSpent / 60)} minutes and ${timeSpent % 60} seconds`;
                    } catch (error) {
                        console.error("Error in success handler:", error);
                        alert("Your skill practice was logged, but there was an error updating the display.");
                    }
                })
                .withFailureHandler(function (error) {
                    try {
                        console.error("Error logging session:", error);
                        alert('Error logging session: ' + error);
                        logButton.disabled = false;
                        logButton.textContent = "Complete Practice Session";
                    } catch (handlingError) {
                        console.error("Error handling failure:", handlingError);
                        alert("An unexpected error occurred. Please try again.");
                        logButton.disabled = false;
                    }
                })
                .logSkillWithTime(logData);
        }

        function logSkillWithTime(skillName, timeSpent, quizScore) {
  const logData = {
    skillName: skillName,
    timeSpent: parseFloat(timeSpent) || 0,
    quizScore: quizScore || ''
  };
  google.script.run
    .withSuccessHandler(result => {
      alert(result);
    })
    .withFailureHandler(error => {
      alert('Error logging session: ' + error.message);
    })
    .logSkillWithTime(logData);
}
    </script>
</body>

</html>